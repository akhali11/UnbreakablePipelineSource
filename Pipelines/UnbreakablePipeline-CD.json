{"source":2,"revision":212,"description":null,"createdBy":{"displayName":"Safia Habib","url":"https://app.vssps.visualstudio.com/A430bc36c-817f-4d6f-ab28-91ed04b1d4f7/_apis/Identities/067a06f8-8dc4-6464-a496-111deb63d372","_links":{"avatar":{"href":"https://dev.azure.com/unbreakablepipeline/_apis/GraphProfile/MemberAvatars/aad.MDY3YTA2ZjgtOGRjNC03NDY0LWE0OTYtMTExZGViNjNkMzcy"}},"id":"067a06f8-8dc4-6464-a496-111deb63d372","uniqueName":"safia.abdullah@gmail.com","imageUrl":"https://dev.azure.com/unbreakablepipeline/_api/_common/identityImage?id=067a06f8-8dc4-6464-a496-111deb63d372","descriptor":"aad.MDY3YTA2ZjgtOGRjNC03NDY0LWE0OTYtMTExZGViNjNkMzcy"},"createdOn":"2018-10-25T13:56:33.067Z","modifiedBy":{"displayName":"Safia Habib","url":"https://app.vssps.visualstudio.com/A430bc36c-817f-4d6f-ab28-91ed04b1d4f7/_apis/Identities/067a06f8-8dc4-6464-a496-111deb63d372","_links":{"avatar":{"href":"https://dev.azure.com/unbreakablepipeline/_apis/GraphProfile/MemberAvatars/aad.MDY3YTA2ZjgtOGRjNC03NDY0LWE0OTYtMTExZGViNjNkMzcy"}},"id":"067a06f8-8dc4-6464-a496-111deb63d372","uniqueName":"safia.abdullah@gmail.com","imageUrl":"https://dev.azure.com/unbreakablepipeline/_api/_common/identityImage?id=067a06f8-8dc4-6464-a496-111deb63d372","descriptor":"aad.MDY3YTA2ZjgtOGRjNC03NDY0LWE0OTYtMTExZGViNjNkMzcy"},"modifiedOn":"2018-11-07T04:43:47.833Z","isDeleted":false,"variables":{"ApplicationName":{"value":"SampleDevOpsApp"},"DeploymentId":{"value":"56789"},"DT_API_TOKEN":{"value":"DT_API_TOKEN"},"DT_TENANT":{"value":"DT_TENANT"},"DT_TENANT_TOKEN":{"value":"DT_TENANT_TOKEN"},"ServiceToCompare":{"value":"SampleJSonService/StagingToProduction"},"SimulateBuildNumber":{"value":"2"}},"variableGroups":[],"environments":[{"id":9,"name":"Staging","rank":1,"owner":{"displayName":"Safia Habib","url":"https://app.vssps.visualstudio.com/A430bc36c-817f-4d6f-ab28-91ed04b1d4f7/_apis/Identities/067a06f8-8dc4-6464-a496-111deb63d372","_links":{"avatar":{"href":"https://dev.azure.com/unbreakablepipeline/_apis/GraphProfile/MemberAvatars/aad.MDY3YTA2ZjgtOGRjNC03NDY0LWE0OTYtMTExZGViNjNkMzcy"}},"id":"067a06f8-8dc4-6464-a496-111deb63d372","uniqueName":"safia.abdullah@gmail.com","imageUrl":"https://dev.azure.com/unbreakablepipeline/_api/_common/identityImage?id=067a06f8-8dc4-6464-a496-111deb63d372","descriptor":"aad.MDY3YTA2ZjgtOGRjNC03NDY0LWE0OTYtMTExZGViNjNkMzcy"},"variables":{},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":26}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":27},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":false,"isNotificationOn":false,"approver":{"displayName":"Safia Habib","url":"https://app.vssps.visualstudio.com/A430bc36c-817f-4d6f-ab28-91ed04b1d4f7/_apis/Identities/067a06f8-8dc4-6464-a496-111deb63d372","_links":{"avatar":{"href":"https://dev.azure.com/unbreakablepipeline/_apis/GraphProfile/MemberAvatars/aad.MDY3YTA2ZjgtOGRjNC03NDY0LWE0OTYtMTExZGViNjNkMzcy"}},"id":"067a06f8-8dc4-6464-a496-111deb63d372","uniqueName":"safia.abdullah@gmail.com","imageUrl":"https://dev.azure.com/unbreakablepipeline/_api/_common/identityImage?id=067a06f8-8dc4-6464-a496-111deb63d372","descriptor":"aad.MDY3YTA2ZjgtOGRjNC03NDY0LWE0OTYtMTExZGViNjNkMzcy"},"id":51}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":true,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[{"artifactItems":[],"alias":"_UnbreakablePipeline-CI","artifactType":"Build","artifactDownloadMode":"All"}]},"queueId":21,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","workflowTasks":[{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Deploy Dynatrace Oneagent ","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# Download and Install the Dynatrace OneAgent\n# Please provide Dynatrace Tenant and Tenant Token in the Variables section \n\nwget  -O Dynatrace-OneAgent-Linux.sh  $(DT_TENANT)\"/api/v1/deployment/installer/agent/unix/default/latest?Api-Token=\"$(DT_TENANT_TOKEN)\"&arch=x86&flavor=default\"\n\necho \"https://\"$(DT_TENANT)\"/api/v1/deployment/installer/agent/unix/default/latest?Api-Token=\"$(DT_TENANT_TOKEN)\"&arch=x86&flavor=default\"\n\nsudo /bin/sh Dynatrace-OneAgent-Linux.sh  APP_LOG_CONTENT_ACCESS=1 INFRA_ONLY=0\n\n","workingDirectory":"","failOnStderr":"false"}},{"environment":{"DT_CUSTOM_PROP":"DEPLOYMENT_ID=$(DeploymentId)","APPLICATION_NAME":"$(ApplicationName)","DEPLOYMENT_ID":"$(DeploymentId)","DEPLOYMENT_GROUP_NAME":"$(Release.EnvironmentName)"},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Initialize Deployment Values","refName":"","enabled":false,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# Write your commands here\n\nsudo rm -R /home/unbreakablepipeline/dynatrace\nsudo mkdir /home/unbreakablepipeline/dynatrace\nsudo chmod -R 777 /home/unbreakablepipeline/dynatrace\ncp -R $(System.DefaultWorkingDirectory)/_UnbreakablePipeline-CI/app /home/unbreakablepipeline/dynatrace\ncp $(System.DefaultWorkingDirectory)/_UnbreakablePipeline-CI/app/start_loadtest.sh /home/unbreakablepipeline/dynatrace\nsudo chmod 777 /home/unbreakablepipeline/dynatrace/app/app.js\nsudo chmod 777 /home/unbreakablepipeline/dynatrace/start_loadtest.sh\n\n","workingDirectory":"","failOnStderr":"false"}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Install pm2","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# Install Npm\n# curl -sL https://deb.nodesource.com/setup_10.x | sudo -E bash -\n# sudo apt-get install -y nodejs\n# npm -v\n# Install pm2\nsudo npm install pm2 -g\n\n","workingDirectory":"","failOnStderr":"false"}},{"environment":{"DT_CLUSTER_ID":"Staging SampleNodeJSService","DEPLOYMENT_GROUP_NAME":"Staging","DT_CUSTOM_PROP":"DEPLOYMENT_ID=$(DeploymentId) DEPLOYMENT_GROUP_NAME=$(Release.EnvironmentName) APPLICATION_NAME=$(ApplicationName)"},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Deploy App","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# We start off with setting build number information - this allows us to control which version of our code we actually run. In our demo env this is the only thing we need to change to \"simulate a new build\"\nexport BUILD_NUMBER=$(SimulateBuildNumber)\necho \"Simulating the Build\" $(SimulateBuildNumber)\n\nexport DEPLOYMENT_GROUP_NAME=$(Release.EnvironmentName)\nexport APPLICATION_NAME=$(ApplicationName)\nexport DT_TAGS=APPLICATION_NAME=$(ApplicationName)\nexport DT_CUSTOM_PROP=\"DEPLOYMENT_ID=$(DeploymentId) DEPLOYMENT_GROUP_NAME=$(Release.EnvironmentName) APPLICATION_NAME=$(ApplicationName)\"\nexport DT_CLUSTER_ID=\"$(Release.EnvironmentName) $(ApplicationName)\"\nenv\n# now we launch our app\n\nsudo pm2 start $(System.DefaultWorkingDirectory)/_UnbreakablePipeline-CI/app/app.js &> pm2start.log\necho \"DT Custom Prop=\"  $DT_CUSTOM_PROP\necho \"DT_Cluster_id=\" $DT_CLUSTER_ID\necho \"DEPLOYMENT_GROUP_NAME=\"  $DEPLOYMENT_GROUP_NAME\necho \"APPLICATION_NAME=\" $APPLICATION_NAME\n\n# now lets make sure the app is really up & running - execute a couple of requests using the x-dynatrace header to identify these requests in Dynatrace as startup tests\nsleep 5;\necho \"Running a simply set of curls to validate the service is up and running\"\ncurl -s \"http://localhost:8080/\" -H \"x-dynatrace: NA=StartUp.Homepage;\" -o nul &> startuptest.log\ncurl -s \"http://localhost:8080/version\" -H \"x-dynatrace: NA=StartUp.Version;\" -o nul &> startuptest.log\ncurl -s \"http://localhost:8080/api/echo?text=This is from a testing script\" -H \"x-dynatrace: NA=StartUp.Echo;\" -o nul &> startuptest.log\ncurl -s \"http://localhost:8080/api/invoke?url=http://www.dynatrace.com\" -H \"x-dynatrace: NA=StartUp.Invoke;\" -o nul &> startuptest.log\nsleep 5;\nexit 0","workingDirectory":"","failOnStderr":"false"}},{"environment":{"DT_CLUSTER_ID":"Staging SampleNodeJSService","DT_CUSTOM_PROP":"DEPLOYMENT_ID=$(DeploymentId) DEPLOYMENT_GROUP_NAME=$(Release.EnvironmentName) APPLICATION_NAME=$(ApplicationName)","DEPLOYMENT_GROUP_NAME":"Staging"},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Stop app","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"sudo pm2 stop 'all'\nsudo pm2 delete 'all'\n\nsed -i -e 's/\\r$//' $(System.DefaultWorkingDirectory)/_UnbreakablePipeline-CI/app/start_loadtest.sh\n\n","workingDirectory":"","failOnStderr":"false"}},{"environment":{"DT_CLUSTER_ID":"Staging SampleNodeJSService","DEPLOYMENT_GROUP_NAME":"Staging","DT_CUSTOM_PROP":"DEPLOYMENT_ID=$(DeploymentId) DEPLOYMENT_GROUP_NAME=$(Release.EnvironmentName) APPLICATION_NAME=$(ApplicationName)"},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Restart app","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# We start off with setting build number information - this allows us to control which version of our code we actually run. In our demo env this is the only thing we need to change to \"simulate a new build\"\nexport BUILD_NUMBER=$(SimulateBuildNumber)\necho \"Simulating the Build\" $(SimulateBuildNumber)\n\nexport DEPLOYMENT_GROUP_NAME=$(Release.EnvironmentName)\nexport APPLICATION_NAME=$(ApplicationName)\nexport DT_TAGS=APPLICATION_NAME=$(ApplicationName)\nexport DT_CUSTOM_PROP=\"DEPLOYMENT_ID=$(DeploymentId) DEPLOYMENT_GROUP_NAME=$(Release.EnvironmentName) APPLICATION_NAME=$(ApplicationName)\"\nexport DT_CLUSTER_ID=\"$(Release.EnvironmentName) $(ApplicationName)\"\nenv\n# now we launch our app\n\nsudo pm2 start $(System.DefaultWorkingDirectory)/_UnbreakablePipeline-CI/app/app.js &> pm2start.log\necho \"DT Custom Prop=\"  $DT_CUSTOM_PROP\necho \"DT_Cluster_id=\" $DT_CLUSTER_ID\necho \"DEPLOYMENT_GROUP_NAME=\"  $DEPLOYMENT_GROUP_NAME\necho \"APPLICATION_NAME=\" $APPLICATION_NAME\n\n# now lets make sure the app is really up & running - execute a couple of requests using the x-dynatrace header to identify these requests in Dynatrace as startup tests\nsleep 5;\necho \"Running a simply set of curls to validate the service is up and running\"\ncurl -s \"http://localhost:8080/\" -H \"x-dynatrace: NA=StartUp.Homepage;\" -o nul &> startuptest.log\ncurl -s \"http://localhost:8080/version\" -H \"x-dynatrace: NA=StartUp.Version;\" -o nul &> startuptest.log\ncurl -s \"http://localhost:8080/api/echo?text=This is from a testing script\" -H \"x-dynatrace: NA=StartUp.Echo;\" -o nul &> startuptest.log\ncurl -s \"http://localhost:8080/api/invoke?url=http://www.dynatrace.com\" -H \"x-dynatrace: NA=StartUp.Invoke;\" -o nul &> startuptest.log\nsleep 5;\nexit 0","workingDirectory":"","failOnStderr":"false"}},{"environment":{"DEPLOYMENT_GROUP_NAME":"Staging"},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Run loadtest","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"filePath","filePath":"$(System.DefaultWorkingDirectory)/_UnbreakablePipeline-CI/app/start_loadtest.sh","arguments":"","script":"\nsudo /bin/bash  $(System.DefaultWorkingDirectory)/_UnbreakablePipeline-CI/app/start_loadtest.sh","workingDirectory":"","failOnStderr":"false"}},{"environment":{},"taskId":"bf193850-9137-11e8-be30-db4e5bcd7ef2","version":"0.*","name":"Dynatrace Push Deployment","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"dtToken":"$(DT_API_TOKEN)","dtTenantUrl":"$(DT_TENANT)","entityType":"SERVICE","tagContext":"ENVIRONMENT","tagName":"DEPLOYMENT_GROUP_NAME","tagValue":"$(Release.EnvironmentName)","deploymentName":"$(Release.DefinitionName)","deploymentVersion":"$(Release.ReleaseId)","deploymentProject":"$(System.TeamProject)","ciLink":"$(System.TeamFoundationCollectionUri)","jenkinsUrl":"$(System.TeamFoundationCollectionUri)","buildUrl":"$(Release.ReleaseUri)","gitCommit":"$(Release.Artifacts.{alias}.RequestedForID)"}},{"environment":{"DEPLOYMENT_GROUP_NAME":"$(Release.EnvironmentName)"},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Run loadtest Again","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"filePath","filePath":"$(System.DefaultWorkingDirectory)/_UnbreakablePipeline-CI/app/start_loadtest.sh","arguments":"","script":"\nsudo /bin/bash  $(System.DefaultWorkingDirectory)/_UnbreakablePipeline-CI/app/start_loadtest.sh","workingDirectory":"","failOnStderr":"false"}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":186,"url":"https://vsrm.dev.azure.com/unbreakablepipeline/f6ae8f0f-33e9-490f-82ac-2b1cfb3dffe9/_apis/Release/releases/186","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":29,"gatesOptions":{"isEnabled":true,"timeout":6,"samplingInterval":5,"stabilizationTime":2,"minimumSuccessDuration":0},"gates":[{"tasks":[{"environment":{},"taskId":"3950d550-9283-11e8-bc67-3dfa2c0696c1","version":"0.*","name":"Dynatrace Unbreakable Pipeline Release Gate ","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"UnbreakableGateFunctionUrl":"https://unbreakablepipelinefunction.azurewebsites.net/api/ProcessUnbreakableGate","UnbreakableGateFunctionKey":"Function Key","monspecUrl":"https://unbreakablepipeline.blob.core.windows.net/monspec/smplmonspec.json","pipelineInfoUrl":"https://unbreakablepipeline.blob.core.windows.net/monspec/smplpipelineinfo.json","dynatraceTennantUrl":"$(DT_TENANT)","dynatraceToken":"$(DT_API_TOKEN)","proxyUrl":"http://40.117.92.217:5000/api/DTCLIProxy/MonspecPullRequest","serviceToCompare":"SampleJSonService/StagingToProduction","compareWindow":"5","PlanUrl":"$(system.CollectionUri)","ProjectId":"$(system.TeamProjectId)","HubName":"$(system.HostType)","PlanId":"$(system.PlanId)","JobId":"$(system.JobId)","TimelineId":"$(system.TimelineId)","TaskInstanceId":"$(system.TaskInstanceId)","AuthToken":"PAT Token"}}]}]},"environmentTriggers":[],"badgeUrl":"https://vsrm.dev.azure.com/unbreakablepipeline/_apis/public/Release/badge/f6ae8f0f-33e9-490f-82ac-2b1cfb3dffe9/7/9"},{"id":14,"name":"Production","rank":2,"owner":{"displayName":"Safia Habib","url":"https://app.vssps.visualstudio.com/A430bc36c-817f-4d6f-ab28-91ed04b1d4f7/_apis/Identities/067a06f8-8dc4-6464-a496-111deb63d372","_links":{"avatar":{"href":"https://dev.azure.com/unbreakablepipeline/_apis/GraphProfile/MemberAvatars/aad.MDY3YTA2ZjgtOGRjNC03NDY0LWE0OTYtMTExZGViNjNkMzcy"}},"id":"067a06f8-8dc4-6464-a496-111deb63d372","uniqueName":"safia.abdullah@gmail.com","imageUrl":"https://dev.azure.com/unbreakablepipeline/_api/_common/identityImage?id=067a06f8-8dc4-6464-a496-111deb63d372","descriptor":"aad.MDY3YTA2ZjgtOGRjNC03NDY0LWE0OTYtMTExZGViNjNkMzcy"},"variables":{},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":44}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":45},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":47}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"healthPercent":0,"deploymentHealthOption":"Custom","tags":["Production"],"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[{"artifactItems":[],"alias":"_UnbreakablePipeline-CI","artifactType":"Build","artifactDownloadMode":"All"}]},"queueId":23,"demands":[],"enableAccessToken":true,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":4,"name":"Deploy the app on Staging","workflowTasks":[{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Deploy Dynatrace Oneagent ","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# Download and Install the Dynatrace OneAgent\n# Please provide Dynatrace Tenant and Tenant Token in the Variables section \n\nwget  -O Dynatrace-OneAgent-Linux.sh  $(DT_TENANT)\"/api/v1/deployment/installer/agent/unix/default/latest?Api-Token=\"$(DT_TENANT_TOKEN)\"&arch=x86&flavor=default\"\n\necho \"https://\"$(DT_TENANT)\".live.dynatrace.com/api/v1/deployment/installer/agent/unix/default/latest?Api-Token=\"$(DT_TENANT_TOKEN)\"&arch=x86&flavor=default\"\n\nsudo /bin/sh Dynatrace-OneAgent-Linux.sh  APP_LOG_CONTENT_ACCESS=1 INFRA_ONLY=0\n\n","workingDirectory":"","failOnStderr":"false"}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Initialize Deployment Values","refName":"","enabled":false,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# Write your commands here\n\n# Use the environment variables input below to pass secret variables to this script\nexport DT_CUSTOM_PROP=DEPLOYMENT_ID=$(DeploymentId) \nexport APPLICATION_NAME=$(ApplicationName)\nexport DEPLOYMENT_ID=$(DeploymentId)\nexport DEPLOYMENT_GROUP_NAME=$(Release.EnvironmentName)\nenv\n\nsudo rm -R /home/unbreakablepipeline/dynatrace\nsudo mkdir /home/unbreakablepipeline/dynatrace\nsudo chmod -R 777 /home/unbreakablepipeline/dynatrace\ncp -R $(System.DefaultWorkingDirectory)/_UnbreakablePipeline-CI/app /home/unbreakablepipeline/dynatrace\ncp $(System.DefaultWorkingDirectory)/_UnbreakablePipeline-CI/app/start_loadtest.sh /home/unbreakablepipeline/dynatrace\nsudo chmod 777 /home/unbreakablepipeline/dynatrace/app/app.js\nsudo chmod 777 /home/unbreakablepipeline/dynatrace/start_loadtest.sh\n\n","workingDirectory":"","failOnStderr":"false"}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Install pm2","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# Install Npm\n#curl -sL https://deb.nodesource.com/setup_10.x | sudo -E bash -\n#sudo apt-get install -y nodejs\n#npm -v\n# Install pm2\nsudo npm install pm2 -g\n\n","workingDirectory":"","failOnStderr":"false"}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Deploy App","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"#!/bin/bash\n# We start off with setting build number information - this allows us to control which version of our code we actually run. In our demo env this is the only thing we need to change to \"simulate a new build\"\nexport BUILD_NUMBER=$(SimulateBuildNumber)\necho \"Simulating the Build\" $(SimulateBuildNumber)\n\n# Now we set our Dyntrace environment variables that get passed to the Node.js processes. Dynatrace OneAgent will automatically add these variables as Process Group Instance properties\nexport DT_TAGS=DEPLOYMENT_GROUP_NAME=$(DeploymentGroupName)\nexport DT_CUSTOM_PROP=DEPLOYMENT_ID=$(DeploymentId)\nexport DEPLOYMENT_GROUP_NAME=$(DeploymentGroupName) \nexport APPLICATION_NAME=$(ApplicationName)\nexport DT_CLUSTER_ID=\"$(DeploymentGroupName) $(ApplicationName)\"\n\n# now we launch our app\n\nsudo pm2 start $(System.DefaultWorkingDirectory)/_UnbreakablePipeline-CI/app/app.js &> pm2start.log\necho \"Deploying DEPLOYMENT_ID=\"  $(DeploymentId)\necho \"DEPLOYMENT_GROUP_NAME=\"  $(DeploymentGroupName) \necho \"APPLICATION_NAME=\"$(ApplicationName)\n\n# now lets make sure the app is really up & running - execute a couple of requests using the x-dynatrace header to identify these requests in Dynatrace as startup tests\nsleep 5;\necho \"Running a simply set of curls to validate the service is up and running\"\ncurl -s \"http://localhost:8080/\" -H \"x-dynatrace: NA=StartUp.Homepage;\" -o nul &> startuptest.log\ncurl -s \"http://localhost:8080/version\" -H \"x-dynatrace: NA=StartUp.Version;\" -o nul &> startuptest.log\ncurl -s \"http://localhost:8080/api/echo?text=This is from a testing script\" -H \"x-dynatrace: NA=StartUp.Echo;\" -o nul &> startuptest.log\ncurl -s \"http://localhost:8080/api/invoke?url=http://www.dynatrace.com\" -H \"x-dynatrace: NA=StartUp.Invoke;\" -o nul &> startuptest.log\nsleep 5;\nexit 0","workingDirectory":"","failOnStderr":"false"}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Restart app","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"export DT_TAGS=DEPLOYMENT_GROUP_NAME=$(DeploymentGroupName)\nexport DT_CUSTOM_PROP=DEPLOYMENT_ID=$(DeploymentId)\nexport DEPLOYMENT_GROUP_NAME=$(DeploymentGroupName) \nexport APPLICATION_NAME=$(ApplicationName)\nexport DT_CLUSTER_ID=\"$(DeploymentGroupName) $(ApplicationName)\"\n\nsudo pm2 restart 'all'\n\nsed -i -e 's/\\r$//' /home/unbreakablepipeline/dynatrace/start_loadtest.sh","workingDirectory":"","failOnStderr":"false"}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Run loadtest","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# Write your commands here\n\n# Use the environment variables input below to pass secret variables to this script\n\nsudo nohup $(System.DefaultWorkingDirectory)/_UnbreakablePipeline-CI/app/start_loadtest.sh >/dev/null 2>&1 &","workingDirectory":"","failOnStderr":"false"}},{"environment":{},"taskId":"bf193850-9137-11e8-be30-db4e5bcd7ef2","version":"0.*","name":"Dynatrace Push Deployment","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"dtToken":"$(DT_API_TOKEN)","dtTenantUrl":"$(DT_TENANT)","entityType":"SERVICE","tagContext":"ENVIRONMENT","tagName":"DEPLOYMENT_GROUP_NAME","tagValue":"$(Release.EnvironmentName)","deploymentName":"$(Release.DefinitionName)","deploymentVersion":"$(Release.ReleaseId)","deploymentProject":"$(System.TeamProject)","ciLink":"$(System.TeamFoundationCollectionUri)","jenkinsUrl":"$(System.TeamFoundationCollectionUri)","buildUrl":"$(Release.ReleaseUri)","gitCommit":"$(Release.Artifacts.{alias}.RequestedForID)"}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[{"name":"Staging","conditionType":2,"value":"4"}],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":151,"url":"https://vsrm.dev.azure.com/unbreakablepipeline/f6ae8f0f-33e9-490f-82ac-2b1cfb3dffe9/_apis/Release/releases/151","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":46,"gatesOptions":{"isEnabled":true,"timeout":6,"samplingInterval":5,"stabilizationTime":2,"minimumSuccessDuration":0},"gates":[{"tasks":[{"environment":{},"taskId":"3950d550-9283-11e8-bc67-3dfa2c0696c1","version":"0.*","name":"Dynatrace Unbreakable Pipeline Release Gate ","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"UnbreakableGateFunctionUrl":"https://unbreakablepipelinefunction.azurewebsites.net/api/ProcessUnbreakableGate","UnbreakableGateFunctionKey":"vv47yGI8xRNZu1piZk/jYDOFhHaciWcH4F07da85k1jFyYIPTJK/nw==","monspecUrl":"https://unbreakablepipeline.blob.core.windows.net/monspec/smplmonspec.json","pipelineInfoUrl":"https://unbreakablepipeline.blob.core.windows.net/monspec/smplpipelineinfo.json","dynatraceTennantUrl":"$(DT_TENANT)","dynatraceToken":"$(DT_API_TOKEN)","proxyUrl":"http://40.117.92.217:5000/api/DTCLIProxy/MonspecPullRequest","serviceToCompare":"SampleJSonService/StagingToProduction","compareWindow":"5","PlanUrl":"$(system.CollectionUri)","ProjectId":"$(system.TeamProjectId)","HubName":"$(system.HostType)","PlanId":"$(system.PlanId)","JobId":"$(system.JobId)","TimelineId":"$(system.TimelineId)","TaskInstanceId":"$(system.TaskInstanceId)","AuthToken":"mfigubzuenuwezrco67epfg4drv6di45zd7k6dngy3yafo52jfra"}}]}]},"environmentTriggers":[],"badgeUrl":"https://vsrm.dev.azure.com/unbreakablepipeline/_apis/public/Release/badge/f6ae8f0f-33e9-490f-82ac-2b1cfb3dffe9/7/14"}],"artifacts":[{"sourceId":"f6ae8f0f-33e9-490f-82ac-2b1cfb3dffe9:15","type":"Build","alias":"_UnbreakablePipeline-CI","definitionReference":{"artifactSourceDefinitionUrl":{"id":"https://dev.azure.com/unbreakablepipeline/_permalink/_build/index?collectionId=38f54010-b5c4-41f0-88e0-3bca292f134a&projectId=f6ae8f0f-33e9-490f-82ac-2b1cfb3dffe9&definitionId=15","name":""},"defaultVersionBranch":{"id":"","name":""},"defaultVersionSpecific":{"id":"","name":""},"defaultVersionTags":{"id":"","name":""},"defaultVersionType":{"id":"selectDuringReleaseCreationType","name":"Specify at the time of release creation"},"definition":{"id":"15","name":"UnbreakablePipeline-CI"},"definitions":{"id":"","name":""},"IsMultiDefinitionType":{"id":"False","name":"False"},"project":{"id":"f6ae8f0f-33e9-490f-82ac-2b1cfb3dffe9","name":"vstspipeline"},"repository":{"id":"af75b962-1439-4be0-8924-2439bf90a12e","name":"UnbreakablePipelineDynatraceProxy"}},"isPrimary":true,"isRetained":false}],"triggers":[],"releaseNameFormat":"Release-$(rev:r)","tags":[],"properties":{"DefinitionCreationSource":{"$type":"System.String","$value":"Other"}},"id":7,"name":"UnbreakablePipeline-CD","path":"\\","projectReference":null,"url":"https://vsrm.dev.azure.com/unbreakablepipeline/f6ae8f0f-33e9-490f-82ac-2b1cfb3dffe9/_apis/Release/definitions/7","_links":{"self":{"href":"https://vsrm.dev.azure.com/unbreakablepipeline/f6ae8f0f-33e9-490f-82ac-2b1cfb3dffe9/_apis/Release/definitions/7"},"web":{"href":"https://dev.azure.com/unbreakablepipeline/f6ae8f0f-33e9-490f-82ac-2b1cfb3dffe9/_release?definitionId=7"}}}